---
import { diffWords } from 'jsdiff';

// --- 1. データの取得と準備 ---
const allPosts = await Astro.glob('../content/forecasts/*.md');
const sortedPosts = allPosts.sort((a, b) => {
    const dateA = a.frontmatter.date ? new Date(a.frontmatter.date).getTime() : 0;
    const dateB = b.frontmatter.date ? new Date(b.frontmatter.date).getTime() : 0;
    return dateB - dateA;
});

const latestPost = sortedPosts.length > 0 ? sortedPosts[0] : null;
const previousPost = sortedPosts.length > 1 ? sortedPosts[1] : null;

const models = ['gpt-4o', 'gemini', 'claude'];

// --- 2. 差分計算とHTML生成のヘルパー関数 ---
function createDiffHtml(latestText, previousText) {
  // 最新のテキストがなければ表示しない
  if (latestText === null || latestText === undefined) {
    return '<span>N/A</span>';
  }
  // 比較対象の過去のテキストがなければ、最新のテキストをそのまま表示
  if (previousText === null || previousText === undefined) {
    return latestText;
  }

  const diff = diffWords(String(previousText), String(latestText));
  return diff.map(part => {
    if (part.added) {
      return `<span class="added">${part.value}</span>`;
    }
    if (part.removed) {
      return `<del>${part.value}</del>`;
    }
    return part.value;
  }).join('');
}

// --- 3. モデルごとの予測と差分を準備 ---
const predictionsWithDiff = models.map(model => {
    const latestPrediction = latestPost?.frontmatter?.predictions?.[model];
    const previousPrediction = previousPost?.frontmatter?.predictions?.[model];
    return {
        model,
        diffHtml: createDiffHtml(latestPrediction, previousPrediction)
    };
});

const latestDate = latestPost?.frontmatter?.date;
---

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIによるAGI実現予測の定点観測</title>
    <style>
        body {
            font-family: sans-serif;
            line-height: 1.6;
            padding: 2em;
            max-width: 800px;
            margin: 0 auto;
            background-color: #f9f9f9;
            color: #333;
        }
        h1, h2 {
            color: #222;
        }
        .prediction-container {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 1.5em;
            margin-bottom: 2em;
            border-radius: 8px;
        }
        .added {
            background-color: #e6ffed;
            text-decoration: none;
        }
        del {
            background-color: #ffebe9;
            text-decoration: line-through;
        }
        span.added, del {
            padding: 0.2em 0;
        }
    </style>
</head>
<body>
    <header>
        <h1>AIによるAGI実現予測の定点観測</h1>
        {latestDate ? (
            <p>最新の予測 ({latestDate})</p>
        ) : (
            <p>予測データがありません。</p>
        )}
    </header>

    <main>
        {predictionsWithDiff.map(prediction => (
            <div class="prediction-container">
                <h2>{prediction.model.toUpperCase()}</h2>
                <p set:html={prediction.diffHtml} />
            </div>
        ))}
    </main>
</body>
</html>
